name: Cross-compile firmware and verify ELF
on: [push, pull_request]

jobs:
  firmware:
    runs-on: ubuntu-24.04
    container:
      image: ghcr.io/janusboandersen/frdm_kl25z_minimal_build/hello:0.1
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      options: --user 0
    steps:
      - uses: actions/checkout@v4

      - name: List files
        shell: bash
        run: ls -R

      - name: Configure and cross-compile
        shell: bash
        run: |
          set -euo pipefail
          rm -rf build
          cmake -S . -B build -G Ninja
          cmake --build build -v

      - name: Run firmware verification tests
        shell: bash
        run: |
          set -euo pipefail
          pytest -v verify/ --firmware build/firmware --junitxml=elf-verification.xml
          echo
          echo "=== Pytest results ==="
          cat elf-verification.xml
          echo "=== Pytest done ==="